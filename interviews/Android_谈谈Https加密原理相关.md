### `HTTPS`加密基础理论

##### `HTTP`的缺点:

* 通讯使用明文(不加密), 内容肯能被窃听
* 不验证通信访的身份, 因此可能遭到伪装
* 无法证明报文的完整性, 所以有可能遭到篡改

该缺点不仅仅在`HTTP`上出现, 其他未加密的协议中也会存在类似的问题.

##### `HTTPS`通信过程

`HTTPS`协议= `HTTP`协议+`SSL/TLS`协议, 在`HTTPS`传输数据的过程中, 需要用`SSL/TLS`对数据进行加密和解密, 用`HTTP`对加密后的数据进行传输.

`HTTPS`为兼顾安全与效率, 同时使用了对称加密和非对称加密. 数据是被对称加密传输的, 对称加密过程需要客户端的一个密钥, 为保证密钥安全传输到服务器端,采用非对称加密对密钥进行加密, 又为保证服务器的公钥的合法性(服务器身份验证), 服务器对公钥采用数字签名. 总的来说: 对数据进行对称加密, 对称加密所用的密钥通过非对称加密传输. 

![](http://jbcdn2.b0.upaiyun.com/2016/07/19e2c23bf080ca34e6ef1714130d0cd4.png)

`HTTPS`在传输过程会涉及到三个密钥:

* 服务器的公钥和私钥, 进行非对称加密
* 客户端生成的随机密钥, 用来进行对称加密
* `CA`(证书认证中心)的公钥和私钥, 用来进行非对称加密

一个`HTTPS`请求实际包含两次`HTTP`传输:

* 客户端向服务器发起`HTTPS`请求，连接到服务器的443端口。
* 服务器端有一个密钥对，即公钥和私钥，是用来进行非对称加密使用的，服务器端保存着私钥，不能将其泄露，公钥可以发送给任何人。
* 服务器将自己的公钥发送给客户端。
* 客户端收到服务器端的公钥之后，会对公钥进行检查，验证其合法性，如果发现发现公钥有问题，那么`HTTPS`传输就无法继续。严格的说，这里应该是验证服务器发送的数字证书的合法性，关于客户端如何验证数字证书的合法性，下文会进行说明。如果公钥合格，那么客户端会生成一个随机值，这个随机值就是用于进行对称加密的密钥，我们将该密钥称之为`client key`，即客户端密钥，这样在概念上和服务器端的密钥容易进行区分。然后用服务器的公钥对客户端密钥进行非对称加密，这样客户端密钥就变成密文了，至此，`HTTPS`中的第一次`HTTP`请求结束。
* 客户端会发起`HTTPS`中的第二个`HTTP`请求，将加密之后的客户端密钥发送给服务器。
* 服务器接收到客户端发来的密文之后，会用自己的私钥对其进行非对称解密，解密之后的明文就是客户端密钥，然后用客户端密钥对数据进行对称加密，这样数据就变成了密文。
* 然后服务器将加密后的密文发送给客户端。
* 客户端收到服务器发送来的密文，用客户端密钥对其进行对称解密，得到服务器发送的数据。这样`HTTPS`中的第二个HTTP请求结束，整个`HTTPS`传输完成。

##### `HTTPS`数字证书

当服务器接收到客户端的请求时, 会向客户端发送自己服务器的公钥, 但是传输过程中可能会遭到篡改, 所以客户端确信公钥是服务器端发送而不是篡改后的, 这时需要数字证书.

数字证书认证机构(`CA`)处于客户端和服务器端双方都认可信赖的第三方机构.`CA`本身有一对公钥和私钥, `CA`会用自己的私钥对要认证的公钥(服务器端的)进行非对称加密, 加密后再加上证书的过期时间等信息组成数字证书.

不论什么平台, 操作系统都会内置全球公认的`CA`, 即设备内置知名`CA`的公钥, 当客户端接收到服务器的证书时, 会进行验证:

* 客户端会用内置的`CA`公钥尝试解密数字证书, 如内置的`CA`的公钥都无法解密证书, 则该数字证书不值得信任. 
* 如果有一个`CA`公钥能成功解密证书, 说明该证书是`CA`的私钥签发的.
* 此外, 还要检查客户端当前访问的服务器的域名是否与数字证书中的`颁发给`这项吻合及检查证书是否过期等.

数字证书的认证过程如下:

* 服务器把自己的公钥登录到数字证书认证机构
* 数字证书认证机构用自己的私钥签署服务器端的公钥并颁发公钥证书
* 客户端拿到服务器公钥证书后, 使用数字认证机构的公钥验证证书的数字签名并确认服务器的公钥的真实性.
* 客户端使用使用服务器端的公钥加密报文后发送.



#### 参考资料

* [图解HTTP]()

* [HTTPS 理论基础及其在 Android 中的最佳实践](http://android.jobbole.com/83787/)

  ​